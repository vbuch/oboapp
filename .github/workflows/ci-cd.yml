name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
  REGION: europe-west1
  IMAGE_NAME: oborishte-ingest

jobs:
  test-ingest:
    name: Test Ingest
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install workspace dependencies
        run: npm ci

      - name: Run unit tests
        working-directory: ./ingest
        run: npm run test:run

  test-web:
    name: Test Web
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install workspace dependencies
        run: npm ci

      - name: Run unit tests
        working-directory: ./web
        run: npm run test:run

  build-and-deploy:
    name: Build and Deploy to GCP
    runs-on: ubuntu-latest
    needs: [test-ingest, test-web]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: read
      id-token: write # Required for Workload Identity Federation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker europe-west1-docker.pkg.dev

      - name: Build and push Docker image
        id: build
        run: |
          set -e  # Exit on error
          IMAGE_TAG="latest"
          REGISTRY_URL="europe-west1-docker.pkg.dev/$PROJECT_ID/oborishte-ingest"

          # Build and push with latest tag
          echo "========================================="
          echo "Building image for commit: $GITHUB_SHA"
          echo "Image tag: $IMAGE_TAG"
          echo "Full image: $REGISTRY_URL/$IMAGE_NAME:$IMAGE_TAG"
          echo "========================================="

          # Submit build from repo root with ingest/Dockerfile
          if gcloud builds submit \
            --config=- \
            --substitutions=_IMAGE_TAG=$IMAGE_TAG,_REGISTRY_URL=$REGISTRY_URL,_IMAGE_NAME=$IMAGE_NAME \
            . <<EOF
          steps:
            - name: 'gcr.io/cloud-builders/docker'
              args: 
                - 'build'
                - '-f'
                - 'ingest/Dockerfile'
                - '-t'
                - '$_REGISTRY_URL/$_IMAGE_NAME:$_IMAGE_TAG'
                - '.'
            - name: 'gcr.io/cloud-builders/docker'
              args: 
                - 'push'
                - '$_REGISTRY_URL/$_IMAGE_NAME:$_IMAGE_TAG'
          images:
            - '$_REGISTRY_URL/$_IMAGE_NAME:$_IMAGE_TAG'
          EOF
          then
            echo "========================================="
            echo "✅ Image built and tagged as $IMAGE_TAG"
            echo "========================================="
          else
            echo "❌ Build failed!"
            exit 1
          fi
          echo "========================================="

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

          # Wait for registry to fully propagate
          echo "Waiting for registry to propagate..."
          sleep 10

          echo "✅ Build completed successfully"

      - name: Grant Artifact Registry access to Cloud Run service account
        run: |
          # Ensure the Cloud Run service account can pull images from Artifact Registry
          echo "Granting Artifact Registry access to ingest-runner service account..."
          gcloud projects add-iam-policy-binding $PROJECT_ID \
            --member="serviceAccount:ingest-runner@$PROJECT_ID.iam.gserviceaccount.com" \
            --role="roles/artifactregistry.reader" \
            --quiet || echo "Permission may already exist"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        run: |
          cd ingest/terraform
          terraform init

      - name: Terraform Plan
        run: |
          cd ingest/terraform

          # Debug: Show what IMAGE_TAG we're using
          echo "Using IMAGE_TAG: ${IMAGE_TAG}"
          echo "Using image: europe-west1-docker.pkg.dev/$PROJECT_ID/oborishte-ingest/$IMAGE_NAME:${IMAGE_TAG}"

          terraform plan \
            -var="project_id=$PROJECT_ID" \
            -var="region=$REGION" \
            -var="image_tag=${IMAGE_TAG}" \
            -var="firebase_project_id=$FIREBASE_PROJECT_ID" \
            -out=tfplan

      - name: Terraform Apply
        run: |
          cd ingest/terraform
          terraform apply -auto-approve tfplan

      - name: Output deployment info
        run: |
          echo "✅ Deployment successful!"
          echo "Image: europe-west1-docker.pkg.dev/$PROJECT_ID/oborishte-ingest/$IMAGE_NAME:latest"
          echo "Region: $REGION"
          echo "Commit: $GITHUB_SHA"
