name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
  REGION: europe-west1
  IMAGE_NAME: oborishte-ingest

jobs:
  test-ingest:
    name: Test Ingest
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"
          cache-dependency-path: ingest/package-lock.json

      - name: Install dependencies
        working-directory: ./ingest
        run: npm ci

      - name: Run unit tests
        working-directory: ./ingest
        run: npm run test:run

  test-web:
    name: Test Web
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        working-directory: ./web
        run: npm ci

      - name: Run unit tests
        working-directory: ./web
        run: npm run test:run

  build-and-deploy:
    name: Build and Deploy to GCP
    runs-on: ubuntu-latest
    needs: [test-ingest, test-web]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: read
      id-token: write # Required for Workload Identity Federation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker europe-west1-docker.pkg.dev

      - name: Build and push Docker image
        id: build
        run: |
          set -e  # Exit on error
          cd ingest
          IMAGE_TAG="${GITHUB_SHA::8}"
          REGISTRY_URL="europe-west1-docker.pkg.dev/$PROJECT_ID/oborishte-ingest"

          # Build and push with commit SHA
          echo "========================================="
          echo "Building image for commit: $GITHUB_SHA"
          echo "Image tag: $IMAGE_TAG"
          echo "Full image: $REGISTRY_URL/$IMAGE_NAME:$IMAGE_TAG"
          echo "========================================="

          # Submit build with the commit SHA tag
          if gcloud builds submit --tag $REGISTRY_URL/$IMAGE_NAME:$IMAGE_TAG .; then
            echo "========================================="
            echo "✅ Image built and tagged as $IMAGE_TAG"
            echo "========================================="
          else
            echo "❌ Build failed!"
            exit 1
          fi
          echo "========================================="

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

          # Wait for GCR to fully propagate
          echo "Waiting for registry to propagate..."
          sleep 15

          # Verify image exists with the specific tag
          echo "Verifying image with tag $IMAGE_TAG in registry..."
          MAX_RETRIES=6
          RETRY_COUNT=0
          IMAGE_FOUND=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if gcloud artifacts docker images describe $REGISTRY_URL/$IMAGE_NAME:$IMAGE_TAG --format="value(image_summary.digest)" 2>/dev/null; then
              echo "✅ Image $REGISTRY_URL/$IMAGE_NAME:$IMAGE_TAG verified in registry"
              IMAGE_FOUND=true
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Image not ready yet, waiting... (attempt $RETRY_COUNT/$MAX_RETRIES)"
                sleep 10
              fi
            fi
          done

          if [ "$IMAGE_FOUND" = false ]; then
            echo "❌ ERROR: Image with tag $IMAGE_TAG not found after $MAX_RETRIES attempts"
            echo "Listing all tags in registry:"
            gcloud artifacts docker images list $REGISTRY_URL/$IMAGE_NAME --limit=10
            exit 1
          fi

          # List recent images
          echo ""
          echo "Recent images in registry:"
          gcloud artifacts docker images list $REGISTRY_URL/$IMAGE_NAME --limit=10

      - name: Grant Artifact Registry access to Cloud Run service account
        run: |
          # Ensure the Cloud Run service account can pull images from Artifact Registry
          echo "Granting Artifact Registry access to ingest-runner service account..."
          gcloud projects add-iam-policy-binding $PROJECT_ID \
            --member="serviceAccount:ingest-runner@$PROJECT_ID.iam.gserviceaccount.com" \
            --role="roles/artifactregistry.reader" \
            --quiet || echo "Permission may already exist"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        run: |
          cd ingest/terraform
          terraform init

      - name: Terraform Plan
        run: |
          cd ingest/terraform

          # Debug: Show what IMAGE_TAG we're using
          echo "Using IMAGE_TAG: ${IMAGE_TAG:-NOT_SET}"
          echo "Using image: gcr.io/$PROJECT_ID/$IMAGE_NAME:${IMAGE_TAG}"

          terraform plan \
            -var="project_id=$PROJECT_ID" \
            -var="region=$REGION" \
            -var="image_tag=${IMAGE_TAG}" \
            -var="firebase_project_id=$FIREBASE_PROJECT_ID" \
            -out=tfplan

      - name: Terraform Apply
        run: |
          cd ingest/terraform
          terraform apply -auto-approve tfplan

      - name: Output deployment info
        run: |
          echo "✅ Deployment successful!"
          echo "Image: europe-west1-docker.pkg.dev/$PROJECT_ID/oborishte-ingest/$IMAGE_NAME:$IMAGE_TAG"
          echo "Region: $REGION"
