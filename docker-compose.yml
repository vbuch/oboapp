version: "3.8"

services:
  firebase-emulators:
    image: node:20
    working_dir: /app
    volumes:
      - ./ingest:/app
      - firebase-data:/root/.cache/firebase/emulators
    ports:
      - "4000:4000" # Emulator UI
      - "8080:8080" # Firestore
      - "9099:9099" # Auth
      - "4400:4400" # Hub
      - "4500:4500" # Logging
    command: >
      sh -c "apt-get update &&
             apt-get install -y wget apt-transport-https &&
             wget -O - https://packages.adoptium.net/artifactory/api/gpg/key/public | apt-key add - &&
             echo 'deb https://packages.adoptium.net/artifactory/deb bookworm main' | tee /etc/apt/sources.list.d/adoptium.list &&
             apt-get update &&
             apt-get install -y temurin-21-jre &&
             npm install -g firebase-tools &&
             firebase emulators:start --project demo-project --import=./emulator-data --export-on-exit"
    environment:
      - FIRESTORE_EMULATOR_HOST=0.0.0.0:8080
      - FIREBASE_AUTH_EMULATOR_HOST=0.0.0.0:9099

volumes:
  firebase-data:
