# Cloud Workflow for Emergent Pipeline
# Runs emergent crawlers (erm-zapad, toplo, sofiyska-voda) in parallel,
# then runs ingest and notify sequentially.
# Always continues to ingest/notify even if some crawlers fail.

main:
  steps:
    - init:
        assign:
          - project: '${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}'
          - region: '${sys.get_env("GOOGLE_CLOUD_LOCATION")}'
    - runCrawlers:
        parallel:
          branches:
            - ermZapad:
                steps:
                  - callErmZapad:
                      try:
                        call: http.post
                        args:
                          url: '${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-erm-zapad:run"}'
                          auth:
                            type: OAuth2
                      except:
                        as: e
                        steps:
                          - log1:
                              call: sys.log
                              args:
                                text: '${"Crawler erm-zapad failed: " + string(e)}'
                                severity: "ERROR"
            - toplo:
                steps:
                  - callToplo:
                      try:
                        call: http.post
                        args:
                          url: '${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-toplo:run"}'
                          auth:
                            type: OAuth2
                      except:
                        as: e
                        steps:
                          - log2:
                              call: sys.log
                              args:
                                text: '${"Crawler toplo failed: " + string(e)}'
                                severity: "ERROR"
            - sofiyskaVoda:
                steps:
                  - callSofiyskaVoda:
                      try:
                        call: http.post
                        args:
                          url: '${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-sofiyska-voda:run"}'
                          auth:
                            type: OAuth2
                      except:
                        as: e
                        steps:
                          - log3:
                              call: sys.log
                              args:
                                text: '${"Crawler sofiyska-voda failed: " + string(e)}'
                                severity: "ERROR"
    - ingest:
        try:
          call: http.post
          args:
            url: '${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/ingest-messages:run"}'
            auth:
              type: OAuth2
        except:
          as: e
          steps:
            - log4:
                call: sys.log
                args:
                  text: '${"Ingest failed: " + string(e)}'
                  severity: "ERROR"
    - notify:
        try:
          call: http.post
          args:
            url: '${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/send-notifications:run"}'
            auth:
              type: OAuth2
        except:
          as: e
          steps:
            - log5:
                call: sys.log
                args:
                  text: '${"Notify failed: " + string(e)}'
                  severity: "ERROR"
    - done:
        return: "completed"
