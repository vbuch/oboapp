# Cloud Workflow for Emergent Pipeline
# Runs emergent crawlers (erm-zapad, toplo, sofiyska-voda) in parallel,
# then runs ingest and notify sequentially.
# Always continues to ingest/notify even if some crawlers fail.

main:
  steps:
    - init:
        assign:
          - project: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
          - region: ${sys.get_env("GOOGLE_CLOUD_LOCATION")}
          - crawlerResults: {}

    - runCrawlersInParallel:
        parallel:
          shared: [crawlerResults]
          branches:
            - crawlErmZapad:
                steps:
                  - tryCallErmZapad:
                      try:
                        call: http.post
                        args:
                          url: ${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-erm-zapad:run"}
                          auth:
                            type: OAuth2
                        result: crawlerResults.ermZapad
                      except:
                        as: e
                        steps:
                          - logError:
                              call: sys.log
                              args:
                                text: ${"Crawler erm-zapad failed: " + string(e)}
                                severity: ERROR

            - crawlToplo:
                steps:
                  - tryCallToplo:
                      try:
                        call: http.post
                        args:
                          url: ${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-toplo:run"}
                          auth:
                            type: OAuth2
                        result: crawlerResults.toplo
                      except:
                        as: e
                        steps:
                          - logError:
                              call: sys.log
                              args:
                                text: ${"Crawler toplo failed: " + string(e)}
                                severity: ERROR

            - crawlSofiyskaVoda:
                steps:
                  - tryCallSofiyskaVoda:
                      try:
                        call: http.post
                        args:
                          url: ${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-sofiyska-voda:run"}
                          auth:
                            type: OAuth2
                        result: crawlerResults.sofiyskaVoda
                      except:
                        as: e
                        steps:
                          - logError:
                              call: sys.log
                              args:
                                text: ${"Crawler sofiyska-voda failed: " + string(e)}
                                severity: ERROR

    - runIngest:
        try:
          call: http.post
          args:
            url: ${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/ingest-messages:run"}
            auth:
              type: OAuth2
          result: ingestResult
        except:
          as: e
          steps:
            - logError:
                call: sys.log
                args:
                  text: ${"Ingest failed: " + string(e)}
                  severity: ERROR
    
    - runNotify:
        try:
          call: http.post
          args:
            url: ${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/send-notifications:run"}
            auth:
              type: OAuth2
          result: notifyResult
        except:
          as: e
          steps:
            - logError:
                call: sys.log
                args:
                  text: ${"Notify failed: " + string(e)}
