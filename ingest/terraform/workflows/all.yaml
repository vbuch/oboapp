# Cloud Workflow for All Crawlers Pipeline
# Runs all 12 crawlers in two parallel batches (10 + 2 due to GCP 10-branch limit),
# then runs ingest and notify sequentially.
# Always continues to ingest/notify even if some crawlers fail.

main:
  steps:
    - init:
        assign:
          - project: '${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}'
          - region: '${sys.get_env("GOOGLE_CLOUD_LOCATION")}'
    - batch1:
        parallel:
          branches:
            - ermZapad:
                steps:
                  - callErmZapad:
                      try:
                        call: http.post
                        args:
                          url: '${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-erm-zapad:run"}'
                          auth:
                            type: OAuth2
                      except:
                        as: e
                        steps:
                          - log1:
                              call: sys.log
                              args:
                                text: '${"Crawler erm-zapad failed: " + string(e)}'
                                severity: "ERROR"
            - toplo:
                steps:
                  - callToplo:
                      try:
                        call: http.post
                        args:
                          url: '${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-toplo:run"}'
                          auth:
                            type: OAuth2
                      except:
                        as: e
                        steps:
                          - log2:
                              call: sys.log
                              args:
                                text: '${"Crawler toplo failed: " + string(e)}'
                                severity: "ERROR"
            - rayonOborishte:
                steps:
                  - callRayonOborishte:
                      try:
                        call: http.post
                        args:
                          url: '${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-rayon-oborishte:run"}'
                          auth:
                            type: OAuth2
                      except:
                        as: e
                        steps:
                          - log3:
                              call: sys.log
                              args:
                                text: '${"Crawler rayon-oborishte failed: " + string(e)}'
                                severity: "ERROR"
            - sofia:
                steps:
                  - callSofia:
                      try:
                        call: http.post
                        args:
                          url: '${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-sofia:run"}'
                          auth:
                            type: OAuth2
                      except:
                        as: e
                        steps:
                          - log4:
                              call: sys.log
                              args:
                                text: '${"Crawler sofia failed: " + string(e)}'
                                severity: "ERROR"
            - mladost:
                steps:
                  - callMladost:
                      try:
                        call: http.post
                        args:
                          url: '${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-mladost:run"}'
                          auth:
                            type: OAuth2
                      except:
                        as: e
                        steps:
                          - log5:
                              call: sys.log
                              args:
                                text: '${"Crawler mladost failed: " + string(e)}'
                                severity: "ERROR"
            - studentski:
                steps:
                  - callStudentski:
                      try:
                        call: http.post
                        args:
                          url: '${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-studentski:run"}'
                          auth:
                            type: OAuth2
                      except:
                        as: e
                        steps:
                          - log6:
                              call: sys.log
                              args:
                                text: '${"Crawler studentski failed: " + string(e)}'
                                severity: "ERROR"
            - sredec:
                steps:
                  - callSredec:
                      try:
                        call: http.post
                        args:
                          url: '${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-sredec:run"}'
                          auth:
                            type: OAuth2
                      except:
                        as: e
                        steps:
                          - log7:
                              call: sys.log
                              args:
                                text: '${"Crawler sredec failed: " + string(e)}'
                                severity: "ERROR"
            - slatina:
                steps:
                  - callSlatina:
                      try:
                        call: http.post
                        args:
                          url: '${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-slatina:run"}'
                          auth:
                            type: OAuth2
                      except:
                        as: e
                        steps:
                          - log8:
                              call: sys.log
                              args:
                                text: '${"Crawler slatina failed: " + string(e)}'
                                severity: "ERROR"
            - lozenets:
                steps:
                  - callLozenets:
                      try:
                        call: http.post
                        args:
                          url: '${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-lozenets:run"}'
                          auth:
                            type: OAuth2
                      except:
                        as: e
                        steps:
                          - log9:
                              call: sys.log
                              args:
                                text: '${"Crawler lozenets failed: " + string(e)}'
                                severity: "ERROR"
            - raioniskar:
                steps:
                  - callRaioniskar:
                      try:
                        call: http.post
                        args:
                          url: '${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-raioniskar:run"}'
                          auth:
                            type: OAuth2
                      except:
                        as: e
                        steps:
                          - log10:
                              call: sys.log
                              args:
                                text: '${"Crawler raioniskar failed: " + string(e)}'
                                severity: "ERROR"
    - batch2:
        parallel:
          branches:
            - sofiyskaVoda:
                steps:
                  - callSofiyskaVoda:
                      try:
                        call: http.post
                        args:
                          url: '${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-sofiyska-voda:run"}'
                          auth:
                            type: OAuth2
                      except:
                        as: e
                        steps:
                          - log11:
                              call: sys.log
                              args:
                                text: '${"Crawler sofiyska-voda failed: " + string(e)}'
                                severity: "ERROR"
            - nimhSevereWeather:
                steps:
                  - callNimhSevereWeather:
                      try:
                        call: http.post
                        args:
                          url: '${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-nimh-severe-weather:run"}'
                          auth:
                            type: OAuth2
                      except:
                        as: e
                        steps:
                          - log12:
                              call: sys.log
                              args:
                                text: '${"Crawler nimh-severe-weather failed: " + string(e)}'
                                severity: "ERROR"
    - ingest:
        try:
          call: http.post
          args:
            url: '${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/ingest-messages:run"}'
            auth:
              type: OAuth2
        except:
          as: e
          steps:
            - log13:
                call: sys.log
                args:
                  text: '${"Ingest failed: " + string(e)}'
                  severity: "ERROR"
    - notify:
        try:
          call: http.post
          args:
            url: '${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/send-notifications:run"}'
            auth:
              type: OAuth2
        except:
          as: e
          steps:
            - log14:
                call: sys.log
                args:
                  text: '${"Notify failed: " + string(e)}'
                  severity: "ERROR"
    - done:
        return: "completed"
