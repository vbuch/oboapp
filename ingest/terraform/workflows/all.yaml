# Cloud Workflow for All Crawlers Pipeline
# Runs all 11 crawlers in two parallel batches (10 + 1 due to GCP limit),
# then runs ingest and notify sequentially.
# Always continues to ingest/notify even if some crawlers fail.

main:
  steps:
    - init:
        assign:
          - project: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
          - region: ${sys.get_env("GOOGLE_CLOUD_LOCATION")}
          - crawlerResults: {}

    - runCrawlersParallel1:
        parallel:
          shared: [crawlerResults]
          branches:
            - crawlErmZapad:
                steps:
                  - tryCallErmZapad:
                      try:
                        call: http.post
                        args:
                          url: ${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-erm-zapad:run"}
                          auth:
                            type: OAuth2
                        result: crawlerResults.ermZapad
                      except:
                        as: e
                        steps:
                          - logError:
                              call: sys.log
                              args:
                                text: ${"Crawler erm-zapad failed: " + string(e)}
                                severity: ERROR

            - crawlToplo:
                steps:
                  - tryCallToplo:
                      try:
                        call: http.post
                        args:
                          url: ${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-toplo:run"}
                          auth:
                            type: OAuth2
                        result: crawlerResults.toplo
                      except:
                        as: e
                        steps:
                          - logError:
                              call: sys.log
                              args:
                                text: ${"Crawler toplo failed: " + string(e)}
                                severity: ERROR

            - crawlSofiyskaVoda:
                steps:
                  - tryCallSofiyskaVoda:
                      try:
                        call: http.post
                        args:
                          url: ${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-sofiyska-voda:run"}
                          auth:
                            type: OAuth2
                        result: crawlerResults.sofiyskaVoda
                      except:
                        as: e
                        steps:
                          - logError:
                              call: sys.log
                              args:
                                text: ${"Crawler sofiyska-voda failed: " + string(e)}
                                severity: ERROR

            - crawlRayonOborishte:
                steps:
                  - tryCallRayonOborishte:
                      try:
                        call: http.post
                        args:
                          url: ${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-rayon-oborishte:run"}
                          auth:
                            type: OAuth2
                        result: crawlerResults.rayonOborishte
                      except:
                        as: e
                        steps:
                          - logError:
                              call: sys.log
                              args:
                                text: ${"Crawler rayon-oborishte failed: " + string(e)}
                                severity: ERROR

            - crawlSofia:
                steps:
                  - tryCallSofia:
                      try:
                        call: http.post
                        args:
                          url: ${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-sofia:run"}
                          auth:
                            type: OAuth2
                        result: crawlerResults.sofia
                      except:
                        as: e
                        steps:
                          - logError:
                              call: sys.log
                              args:
                                text: ${"Crawler sofia failed: " + string(e)}
                                severity: ERROR

            - crawlMladost:
                steps:
                  - tryCallMladost:
                      try:
                        call: http.post
                        args:
                          url: ${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-mladost:run"}
                          auth:
                            type: OAuth2
                        result: crawlerResults.mladost
                      except:
                        as: e
                        steps:
                          - logError:
                              call: sys.log
                              args:
                                text: ${"Crawler mladost failed: " + string(e)}
                                severity: ERROR

            - crawlStudentski:
                steps:
                  - tryCallStudentski:
                      try:
                        call: http.post
                        args:
                          url: ${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-studentski:run"}
                          auth:
                            type: OAuth2
                        result: crawlerResults.studentski
                      except:
                        as: e
                        steps:
                          - logError:
                              call: sys.log
                              args:
                                text: ${"Crawler studentski failed: " + string(e)}
                                severity: ERROR

            - crawlSredec:
                steps:
                  - tryCallSredec:
                      try:
                        call: http.post
                        args:
                          url: ${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-sredec:run"}
                          auth:
                            type: OAuth2
                        result: crawlerResults.sredec
                      except:
                        as: e
                        steps:
                          - logError:
                              call: sys.log
                              args:
                                text: ${"Crawler sredec failed: " + string(e)}
                                severity: ERROR

            - crawlSlatina:
                steps:
                  - tryCallSlatina:
                      try:
                        call: http.post
                        args:
                          url: ${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-slatina:run"}
                          auth:
                            type: OAuth2
                        result: crawlerResults.slatina
                      except:
                        as: e
                        steps:
                          - logError:
                              call: sys.log
                              args:
                                text: ${"Crawler slatina failed: " + string(e)}
                                severity: ERROR

            - crawlLozenets:
                steps:
                  - tryCallLozenets:
                      try:
                        call: http.post
                        args:
                          url: ${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-lozenets:run"}
                          auth:
                            type: OAuth2
                        result: crawlerResults.lozenets
                      except:
                        as: e
                        steps:
                          - logError:
                              call: sys.log
                              args:
                                text: ${"Crawler lozenets failed: " + string(e)}
                                severity: ERROR

    - runCrawlersParallel2:
        parallel:
          shared: [crawlerResults]
          branches:
            - crawlNimhSevereWeather:
                steps:
                  - tryCallNimhSevereWeather:
                      try:
                        call: http.post
                        args:
                          url: ${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/crawl-nimh-severe-weather:run"}
                          auth:
                            type: OAuth2
                        result: crawlerResults.nimhSevereWeather
                      except:
                        as: e
                        steps:
                          - logError:
                              call: sys.log
                              args:
                                text: ${"Crawler nimh-severe-weather failed: " + string(e)}
                                severity: ERROR

    - runIngest:
        try:
          call: http.post
          args:
            url: ${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/ingest-messages:run"}
            auth:
              type: OAuth2
          result: ingestResult
        except:
          as: e
          steps:
            - logError:
                call: sys.log
                args:
                  text: ${"Ingest failed: " + string(e)}
                  severity: ERROR

    - runNotify:
        try:
          call: http.post
          args:
            url: ${"https://" + region + "-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/" + project + "/jobs/send-notifications:run"}
            auth:
              type: OAuth2
          result: notifyResult
        except:
          as: e
          steps:
            - logError:
                call: sys.log
                args:
                  text: ${"Notify failed: " + string(e)}
                  severity: ERROR

    - complete:
        return: ${crawlerResults}
